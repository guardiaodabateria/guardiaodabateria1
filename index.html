<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pedido de Bateria</title>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0b0f1a;
  color: #fff;
  line-height: 1.4;
}

body.light-mode {
  background: #f5f5f5;
  color: #333;
}

body.light-mode .box {
  background: #fff;
  border-color: #ddd;
}

body.light-mode .info-box {
  background: #e3f2fd;
  border-left-color: #1e90ff;
  color: #333;
}

body.light-mode input,
body.light-mode select,
body.light-mode textarea {
  background: #fff;
  border-color: #ddd;
  color: #333;
}

header {
  background: #05070d;
  padding: 20px;
  text-align: center;
  position: relative;
}

body.light-mode header {
  background: #1e90ff;
}

header img {
  max-width: 260px;
  height: auto;
}

.container {
  max-width: 480px;
  margin: auto;
  padding: 15px;
  min-height: calc(100vh - 80px);
}

.box {
  background: #12172a;
  padding: 20px;
  margin-bottom: 15px;
  border-radius: 8px;
  border: 1px solid #1b2345;
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  border: none;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.primary {
  background: #1e90ff;
  color: #fff;
}

.primary:hover:not(:disabled) {
  background: #4da6ff;
}

.secondary {
  background: #1b2345;
  color: #fff;
  border: 1px solid #2c3a5f;
}

body.light-mode .secondary {
  background: #e0e0e0;
  color: #333;
  border-color: #ccc;
}

.secondary:hover:not(:disabled) {
  background: #2c3a5f;
}

body.light-mode .secondary:hover:not(:disabled) {
  background: #d0d0d0;
}

.success {
  background: #28a745;
  color: #fff;
}

.success:hover:not(:disabled) {
  background: #34ce57;
}

.danger {
  background: #dc3545;
  color: #fff;
}

.danger:hover:not(:disabled) {
  background: #c82333;
}

.small-btn {
  width: calc(50% - 4px);
  display: inline-block;
  margin-right: 8px;
}

.small-btn:last-child {
  margin-right: 0;
}

input, select, textarea {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 6px;
  border: 1px solid #2c3a5f;
  background: #1b2345;
  color: #fff;
  font-size: 14px;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #1e90ff;
  box-shadow: 0 0 0 2px rgba(30, 144, 255, 0.2);
}

.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 10px;
}

.parcelas-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 10px;
}

/* CALEND√ÅRIO COMPACTO */
.calendario-wrapper {
  max-width: 320px;
  margin: 15px auto;
}

.mes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding: 8px;
  background: #1b2345;
  border-radius: 6px;
}

body.light-mode .mes-header {
  background: #e3f2fd;
}

.mes-header button {
  width: auto;
  padding: 6px 12px;
  margin: 0;
  font-size: 18px;
}

.mes-nome {
  font-weight: bold;
  font-size: 15px;
}

body.light-mode .mes-nome {
  color: #333;
}

.calendario {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.dia-semana {
  text-align: center;
  font-weight: bold;
  padding: 8px 4px;
  background: #1b2345;
  border-radius: 4px;
  font-size: 11px;
  color: #aaa;
}

body.light-mode .dia-semana {
  background: #e3f2fd;
  color: #666;
}

.dia {
  text-align: center;
  padding: 10px 4px;
  background: #2c3a5f;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s;
  min-height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
}

body.light-mode .dia {
  background: #fff;
  border: 1px solid #ddd;
  color: #333;
}

.dia:hover:not(.indisponivel):not(.vazio) {
  background: #1e90ff;
  transform: scale(1.05);
}

body.light-mode .dia:hover:not(.indisponivel):not(.vazio) {
  background: #1e90ff;
  color: #fff;
}

.dia.selecionado {
  background: #1e90ff !important;
  font-weight: bold;
  color: #fff !important;
  box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.3);
}

.dia.indisponivel {
  background: #1a1a1a;
  color: #555;
  cursor: not-allowed;
  opacity: 0.4;
}

body.light-mode .dia.indisponivel {
  background: #f5f5f5;
  color: #ccc;
}

.dia.vazio {
  background: transparent;
  cursor: default;
}

.dia.hoje {
  border: 2px solid #1e90ff;
}

/* HOR√ÅRIOS */
.horarios-section {
  margin-top: 20px;
}

.horarios-section h4 {
  margin-bottom: 10px;
  color: #1e90ff;
}

.horarios {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  max-width: 400px;
}

.horario {
  padding: 12px 8px;
  background: #2c3a5f;
  border-radius: 6px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  border: 2px solid transparent;
  position: relative;
}

body.light-mode .horario {
  background: #fff;
  border: 2px solid #ddd;
  color: #333;
}

.horario:hover:not(.ocupado) {
  background: #1e90ff;
  transform: translateY(-2px);
  color: #fff;
}

.horario.selecionado {
  background: #1e90ff !important;
  font-weight: bold;
  color: #fff !important;
  border-color: #4da6ff;
  box-shadow: 0 0 0 1px #4da6ff;
}

.horario.ocupado {
  background: #3d1a1a;
  color: #ff6b6b;
  cursor: not-allowed;
  opacity: 0.6;
}

body.light-mode .horario.ocupado {
  background: #ffe0e0;
  color: #c00;
}

.horario.ocupado::after {
  content: '‚ùå';
  position: absolute;
  top: 2px;
  right: 4px;
  font-size: 10px;
}

/* ADMIN HOR√ÅRIO */
.horario.admin-mode {
  border: 2px dashed #ffa500;
}

.horario.admin-mode:hover {
  background: #ffa500;
}

.whatsapp {
  position: fixed;
  bottom: 15px;
  right: 15px;
  background: #25d366;
  color: #fff;
  padding: 12px 16px;
  border-radius: 50px;
  font-weight: bold;
  text-decoration: none;
  box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
  transition: all 0.3s ease;
  z-index: 1000;
}

.whatsapp:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(37, 211, 102, 0.6);
}

.admin-btn {
  position: fixed;
  top: 15px;
  right: 15px;
  background: #ff6b6b;
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: bold;
  text-decoration: none;
  box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
  transition: all 0.3s ease;
  z-index: 1000;
  cursor: pointer;
  font-size: 11px;
  opacity: 0.7;
}

.admin-btn:hover {
  opacity: 1;
  box-shadow: 0 4px 12px rgba(255, 107, 107, 0.6);
}

.admin-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ff0000;
  color: #fff;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.theme-toggle {
  position: fixed;
  top: 15px;
  left: 15px;
  background: #ffa500;
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(255, 165, 0, 0.4);
  transition: all 0.3s ease;
  z-index: 1000;
  cursor: pointer;
  font-size: 11px;
  opacity: 0.7;
}

.theme-toggle:hover {
  opacity: 1;
  box-shadow: 0 4px 12px rgba(255, 165, 0, 0.6);
}

.error {
  color: #ff6b6b;
  font-size: 13px;
  margin-top: 5px;
}

.hidden {
  display: none !important;
}

.info-box {
  background: #1b2345;
  padding: 15px;
  border-radius: 6px;
  margin: 10px 0;
  border-left: 3px solid #1e90ff;
}

.warning-box {
  background: #3d2a1a;
  padding: 15px;
  border-radius: 6px;
  margin: 10px 0;
  border-left: 3px solid #ffa500;
  color: #ffa500;
}

body.light-mode .warning-box {
  background: #fff3cd;
  color: #856404;
  border-left-color: #ffc107;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 2000;
  overflow-y: auto;
}

.modal.ativo {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 20px;
  padding-top: 40px;
}

.modal-content {
  background: #12172a;
  padding: 20px;
  border-radius: 8px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  border: 1px solid #1b2345;
}

body.light-mode .modal-content {
  background: #fff;
  border-color: #ddd;
}

.modal-content h3 {
  margin-top: 0;
  color: #1e90ff;
}

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid #1b2345;
  flex-wrap: wrap;
}

body.light-mode .tabs {
  border-bottom-color: #ddd;
}

.tab {
  padding: 10px 20px;
  background: transparent;
  border: none;
  color: #888;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  margin: 0;
}

.tab.ativo {
  color: #1e90ff;
  border-bottom-color: #1e90ff;
}

.tab-content {
  display: none;
}

.tab-content.ativo {
  display: block;
}

.pedido-item {
  background: #1b2345;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 6px;
  border-left: 3px solid #1e90ff;
}

body.light-mode .pedido-item {
  background: #f8f9fa;
  border-left-color: #1e90ff;
}

.pedido-item small {
  color: #888;
}

body.light-mode .pedido-item small {
  color: #666;
}

.pedido-item .pedido-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.pedido-item.novo {
  animation: highlight 2s;
}

@keyframes highlight {
  0%, 100% { background: #1b2345; }
  50% { background: #2c4a6f; }
}

body.light-mode .pedido-item.novo {
  animation: highlightLight 2s;
}

@keyframes highlightLight {
  0%, 100% { background: #f8f9fa; }
  50% { background: #e3f2fd; }
}

.agendamento-manual {
  background: #1b2345;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 15px;
}

body.light-mode .agendamento-manual {
  background: #f8f9fa;
}

.horario-bloqueado-item {
  background: #3d1a1a;
  padding: 12px;
  margin-bottom: 8px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-left: 3px solid #ff6b6b;
}

body.light-mode .horario-bloqueado-item {
  background: #ffe0e0;
  color: #333;
}

.horario-bloqueado-item button {
  width: auto;
  padding: 6px 12px;
  margin: 0;
  font-size: 12px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.stat-card {
  background: #1b2345;
  padding: 15px;
  border-radius: 6px;
  text-align: center;
  border-left: 3px solid #1e90ff;
}

body.light-mode .stat-card {
  background: #f8f9fa;
}

.stat-number {
  font-size: 32px;
  font-weight: bold;
  color: #1e90ff;
  display: block;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 12px;
  color: #888;
}

.cupom-box {
  background: #1b2345;
  padding: 12px;
  border-radius: 6px;
  margin-top: 15px;
  border: 2px dashed #28a745;
}

body.light-mode .cupom-box {
  background: #f8f9fa;
}

.cupom-aplicado {
  color: #28a745;
  font-weight: bold;
  margin-top: 10px;
}

@media (max-width: 480px) {
  .container {
    padding: 10px;
  }
  
  .box {
    padding: 15px;
  }
  
  .parcelas-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .calendario-wrapper {
    max-width: 280px;
  }
  
  .dia {
    font-size: 12px;
    min-height: 32px;
    padding: 8px 2px;
  }
  
  .horarios {
    grid-template-columns: repeat(2, 1fr);
    max-width: 100%;
  }
  
  .horario {
    font-size: 13px;
    padding: 10px 6px;
  }
  
  .tabs {
    flex-wrap: wrap;
  }
  
  .tab {
    font-size: 13px;
    padding: 8px 12px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<header>
  <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
</header>

<div class="container">

  <div id="etapa1" class="box">
    <h3>üîã O que voc√™ precisa?</h3>
    <button class="primary" onclick="selecionarServico('bateria')">üîã Comprar Bateria</button>
    <button class="secondary" onclick="selecionarServico('socorro')">üöó Socorro / Transfer√™ncia</button>
  </div>

  <div id="etapas"></div>
  <div id="baterias"></div>
  <div id="dados"></div>
  <div id="pagamento"></div>
  <div id="agenda"></div>
  <div id="resumo"></div>

</div>

<a class="whatsapp" href="https://wa.me/554391261624" target="_blank">
  üí¨ WhatsApp
</a>

<button class="admin-btn" onclick="tentarAbrirAdmin()">
  ‚öôÔ∏è Admin
  <span id="adminBadge" class="admin-badge hidden">0</span>
</button>

<button class="theme-toggle" onclick="toggleTheme()">
  üåì Tema
</button>

<!-- Modal Admin -->
<div id="modalAdmin" class="modal">
  <div class="modal-content">
    <h3>‚öôÔ∏è Painel Administrativo</h3>
    
    <div class="tabs">
      <button class="tab ativo" onclick="mudarTab('stats')">üìä Estat√≠sticas</button>
      <button class="tab" onclick="mudarTab('pedidos')">üìã Pedidos</button>
      <button class="tab" onclick="mudarTab('bloquear')">üö´ Bloquear</button>
      <button class="tab" onclick="mudarTab('bloqueados')">üìÖ Bloqueados</button>
      <button class="tab" onclick="mudarTab('config')">‚öôÔ∏è Config</button>
    </div>
    
    <!-- Tab Estat√≠sticas -->
    <div id="tabStats" class="tab-content ativo">
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-number" id="statTotal">0</span>
          <span class="stat-label">Total de Pedidos</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="statHoje">0</span>
          <span class="stat-label">Pedidos Hoje</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="statSemana">0</span>
          <span class="stat-label">Esta Semana</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="statMes">0</span>
          <span class="stat-label">Este M√™s</span>
        </div>
      </div>
      
      <h4>üì¶ Bateria Mais Vendida</h4>
      <div id="bateriaMaisVendida"></div>
      
      <h4>‚è∞ Hor√°rios Mais Procurados</h4>
      <div id="horariosMaisProcurados"></div>
    </div>
    
    <!-- Tab Pedidos -->
    <div id="tabPedidos" class="tab-content">
      <div id="listaPedidos"></div>
    </div>
    
    <!-- Tab Bloquear Hor√°rios -->
    <div id="tabBloquear" class="tab-content">
      <div class="warning-box">
        <strong>‚ö†Ô∏è Modo de Bloqueio</strong><br>
        <small>Selecione uma data e clique nos hor√°rios que deseja bloquear para clientes</small>
      </div>
      <div class="agendamento-manual">
        <input type="date" id="dataBloqueio" onchange="mostrarHorariosBloqueio()">
        <div id="horariosBloqueio" style="margin-top: 15px;"></div>
      </div>
    </div>
    
    <!-- Tab Bloqueados -->
    <div id="tabBloqueados" class="tab-content">
      <div id="listaBloqueados"></div>
    </div>
    
    <!-- Tab Configura√ß√µes -->
    <div id="tabConfig" class="tab-content">
      <h4>üíæ Backup e Dados</h4>
      <button class="success" onclick="exportarDados()">üì• Exportar Pedidos (CSV)</button>
      <button class="success" onclick="exportarBloqueados()">üì• Exportar Bloqueados (CSV)</button>
      <button class="danger" onclick="limparPedidosAntigos()">üóëÔ∏è Limpar Pedidos Antigos (30+ dias)</button>
      
      <h4 style="margin-top: 20px;">üé® Personaliza√ß√£o</h4>
      <label>Cor Principal:</label>
      <input type="color" id="corPrincipal" value="#1e90ff" onchange="alterarCor(this.value)">
      
      <h4 style="margin-top: 20px;">üéüÔ∏è Cupons de Desconto</h4>
      <div id="listaCupons"></div>
      <button class="secondary" onclick="adicionarCupom()">‚ûï Adicionar Cupom</button>
    </div>
    
    <button class="secondary" onclick="fecharAdmin()" style="margin-top: 20px;">Fechar</button>
  </div>
</div>

<!-- Modal Login -->
<div id="modalLogin" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <h3>üîê Login Administrativo</h3>
    <p style="color: #888;">Digite a senha de acesso:</p>
    <input type="password" id="senhaAdmin" placeholder="Senha" onkeypress="if(event.key==='Enter') verificarSenha()">
    <button class="primary" onclick="verificarSenha()">Entrar</button>
    <button class="secondary" onclick="fecharLogin()">Cancelar</button>
    <p id="erroSenha" class="error hidden">‚ùå Senha incorreta!</p>
  </div>
</div>

<!-- Modal Cupom -->
<div id="modalCupom" class="modal">
  <div class="modal-content" style="max-width: 400px;">
    <h3>üéüÔ∏è Adicionar Cupom</h3>
    <input type="text" id="cupomCodigo" placeholder="C√≥digo do cupom (ex: DESC10)">
    <input type="number" id="cupomValor" placeholder="Desconto em %" min="1" max="100">
    <button class="success" onclick="salvarCupom()">Salvar</button>
    <button class="secondary" onclick="fecharModalCupom()">Cancelar</button>
  </div>
</div>

<script>
// ================== CONFIGURA√á√ÉO ==================
const SENHA_ADMIN = 'admin123';  // ‚ö†Ô∏è TROQUE POR UMA SENHA FORTE!

// ================== VARI√ÅVEIS GLOBAIS ==================
const etapas = document.getElementById("etapas");
const bateriasDiv = document.getElementById("baterias");
const dadosDiv = document.getElementById("dados");
const pagamentoDiv = document.getElementById("pagamento");
const agenda = document.getElementById("agenda");
const resumo = document.getElementById("resumo");

let pedido = {};
let mesAtual = new Date();
let modoAdmin = false;
let dataAdminSelecionada = null;
let ultimosPedidosLidos = 0;

// Configura√ß√£o de baterias
const bateriasCarro = {
  45: {
    casco: 60,
    baterias: [
      { nome:"Interlagos 45Ah Convencional", vista:259, prazo:299 },
      { nome:"Interlagos 45Ah Selada", vista:289, prazo:329 },
      { nome:"Impact 48Ah", vista:349, prazo:399 },
      { nome:"Moura 48Ah", vista:519, prazo:589 },
      { nome:"Heliar 48Ah", vista:519, prazo:589 }
    ]
  },
  50: {
    casco: 60,
    baterias: [
      { nome:"Impact 50Ah Selada (18 meses)", vista:389, prazo:449 },
      { nome:"Moura 50Ah Selada (2 anos)", vista:529, prazo:599 },
      { nome:"Heliar 50Ah Selada (2 anos)", vista:559, prazo:629 }
    ]
  },
  60: {
    casco: 70,
    baterias: [
      { nome:"Interlagos com manuten√ß√£o", vista:279, prazo:319 },
      { nome:"Interlagos Selada", vista:319, prazo:359 },
      { nome:"Impact Premium", vista:399, prazo:459 },
      { nome:"Impact Evolution", vista:449, prazo:519 },
      { nome:"Moura", vista:539, prazo:609 },
      { nome:"Heliar", vista:539, prazo:609 }
    ]
  },
  70: {
    casco: 80,
    baterias: [
      { nome:"Interlagos 70Ah com manuten√ß√£o (1 ano)", vista:349, prazo:399 },
      { nome:"Interlagos 70Ah Selada (1 ano)", vista:399, prazo:459 },
      { nome:"Impact 70Ah Selada (1 ano)", vista:449, prazo:509 },
      { nome:"Moura 70Ah Selada (2 anos)", vista:780, prazo:890 }
    ]
  }
};

// ================== TEMA ==================
function toggleTheme() {
  document.body.classList.toggle('light-mode');
  const tema = document.body.classList.contains('light-mode') ? 'light' : 'dark';
  localStorage.setItem('tema', tema);
}

// Carregar tema salvo
const temaSalvo = localStorage.getItem('tema');
if (temaSalvo === 'light') {
  document.body.classList.add('light-mode');
}

// ================== FUN√á√ïES LOCALSTORAGE ==================

function buscarPedidos() {
  const dados = localStorage.getItem('pedidos');
  return dados ? JSON.parse(dados) : [];
}

function salvarPedido(novoPedido) {
  const pedidos = buscarPedidos();
  novoPedido.id = Date.now();
  novoPedido.timestamp = new Date().toISOString();
  novoPedido.lido = false;
  pedidos.push(novoPedido);
  localStorage.setItem('pedidos', JSON.stringify(pedidos));
  atualizarBadgeAdmin();
  return true;
}

function buscarHorariosBloqueados() {
  const dados = localStorage.getItem('horariosBloqueados');
  return dados ? JSON.parse(dados) : [];
}

function bloquearHorario(data, horario, motivo = 'Bloqueado manualmente') {
  const bloqueados = buscarHorariosBloqueados();
  const novo = {
    id: Date.now(),
    data,
    horario,
    motivo,
    timestamp: new Date().toISOString()
  };
  bloqueados.push(novo);
  localStorage.setItem('horariosBloqueados', JSON.stringify(bloqueados));
}

function desbloquearHorario(id) {
  let bloqueados = buscarHorariosBloqueados();
  bloqueados = bloqueados.filter(h => h.id !== id);
  localStorage.setItem('horariosBloqueados', JSON.stringify(bloqueados));
}

function verificarHorarioOcupado(data, horario) {
  const bloqueados = buscarHorariosBloqueados();
  return bloqueados.some(h => h.data === data && h.horario === horario);
}

function removerPedido(id) {
  let pedidos = buscarPedidos();
  pedidos = pedidos.filter(p => p.id !== id);
  localStorage.setItem('pedidos', JSON.stringify(pedidos));
  atualizarBadgeAdmin();
}

function marcarPedidosComoLidos() {
  let pedidos = buscarPedidos();
  pedidos.forEach(p => p.lido = true);
  localStorage.setItem('pedidos', JSON.stringify(pedidos));
  atualizarBadgeAdmin();
}

function atualizarBadgeAdmin() {
  const pedidos = buscarPedidos();
  const naoLidos = pedidos.filter(p => !p.lido).length;
  const badge = document.getElementById('adminBadge');
  
  if (naoLidos > 0) {
    badge.textContent = naoLidos;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

// ================== CUPONS ==================

function buscarCupons() {
  const dados = localStorage.getItem('cupons');
  return dados ? JSON.parse(dados) : [];
}

function salvarCupons(cupons) {
  localStorage.setItem('cupons', JSON.stringify(cupons));
}

function adicionarCupom() {
  document.getElementById('modalCupom').classList.add('ativo');
}

function fecharModalCupom() {
  document.getElementById('modalCupom').classList.remove('ativo');
  document.getElementById('cupomCodigo').value = '';
  document.getElementById('cupomValor').value = '';
}

function salvarCupom() {
  const codigo = document.getElementById('cupomCodigo').value.toUpperCase().trim();
  const valor = parseInt(document.getElementById('cupomValor').value);
  
  if (!codigo || !valor || valor < 1 || valor > 100) {
    alert('Preencha c√≥digo e desconto v√°lido (1-100%)');
    return;
  }
  
  const cupons = buscarCupons();
  cupons.push({ codigo, desconto: valor, ativo: true });
  salvarCupons(cupons);
  
  fecharModalCupom();
  atualizarListaCupons();
}

function removerCupom(codigo) {
  let cupons = buscarCupons();
  cupons = cupons.filter(c => c.codigo !== codigo);
  salvarCupons(cupons);
  atualizarListaCupons();
}

function atualizarListaCupons() {
  const cupons = buscarCupons();
  const lista = document.getElementById('listaCupons');
  
  if (cupons.length === 0) {
    lista.innerHTML = '<p style="color: #888;">Nenhum cupom cadastrado</p>';
    return;
  }
  
  let html = '';
  cupons.forEach(c => {
    html += `
      <div class="horario-bloqueado-item">
        <div>
          <strong>${c.codigo}</strong> - ${c.desconto}% de desconto
        </div>
        <button class="danger" onclick="if(confirm('Remover cupom?')) removerCupom('${c.codigo}'); ">‚ùå</button>
      </div>`;
  });
  
  lista.innerHTML = html;
}

function aplicarCupom(codigo) {
  const cupons = buscarCupons();
  const cupom = cupons.find(c => c.codigo === codigo.toUpperCase() && c.ativo);
  
  if (cupom) {
    pedido.cupom = cupom;
    const desconto = (pedido.valorFinal * cupom.desconto) / 100;
    pedido.valorComDesconto = pedido.valorFinal - desconto;
    return true;
  }
  return false;
}

// ================== EXPORTA√á√ÉO ==================

function exportarDados() {
  const pedidos = buscarPedidos();
  
  if (pedidos.length === 0) {
    alert('Nenhum pedido para exportar');
    return;
  }
  
  let csv = 'Data,Horario,Nome,Telefone,Veiculo,Tipo,Produto,Valor,Pagamento,Endereco\n';
  
  pedidos.forEach(p => {
    const data = new Date(p.dataAgendamento + 'T12:00:00').toLocaleDateString('pt-BR');
    csv += `"${data}","${p.horario}","${p.nome}","${p.telefone}","${p.veiculo}","${p.tipo}","${p.produto || 'N/A'}","${p.valorFinal || 0}","${p.formaPagamento || 'N/A'}","${p.endereco}"\n`;
  });
  
  baixarArquivo('pedidos.csv', csv);
}

function exportarBloqueados() {
  const bloqueados = buscarHorariosBloqueados();
  
  if (bloqueados.length === 0) {
    alert('Nenhum hor√°rio bloqueado para exportar');
    return;
  }
  
  let csv = 'Data,Horario,Motivo\n';
  
  bloqueados.forEach(h => {
    const data = new Date(h.data + 'T12:00:00').toLocaleDateString('pt-BR');
    csv += `"${data}","${h.horario}","${h.motivo}"\n`;
  });
  
  baixarArquivo('horarios-bloqueados.csv', csv);
}

function baixarArquivo(nome, conteudo) {
  const blob = new Blob([conteudo], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = nome;
  link.click();
}

function limparPedidosAntigos() {
  if (!confirm('Remover pedidos com mais de 30 dias?')) return;
  
  const pedidos = buscarPedidos();
  const hoje = new Date();
  const limite = new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
  
  const pedidosNovos = pedidos.filter(p => {
    const dataPedido = new Date(p.timestamp);
    return dataPedido >= limite;
  });
  
  localStorage.setItem('pedidos', JSON.stringify(pedidosNovos));
  alert(`${pedidos.length - pedidosNovos.length} pedidos removidos`);
  atualizarTabPedidos();
  calcularEstatisticas();
}

// ================== ESTAT√çSTICAS ==================

function calcularEstatisticas() {
  const pedidos = buscarPedidos();
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  
  const inicioSemana = new Date(hoje);
  inicioSemana.setDate(hoje.getDate() - hoje.getDay());
  
  const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  
  const pedidosHoje = pedidos.filter(p => {
    const dataPedido = new Date(p.timestamp);
    dataPedido.setHours(0, 0, 0, 0);
    return dataPedido.getTime() === hoje.getTime();
  }).length;
  
  const pedidosSemana = pedidos.filter(p => {
    const dataPedido = new Date(p.timestamp);
    return dataPedido >= inicioSemana;
  }).length;
  
  const pedidosMes = pedidos.filter(p => {
    const dataPedido = new Date(p.timestamp);
    return dataPedido >= inicioMes;
  }).length;
  
  document.getElementById('statTotal').textContent = pedidos.length;
  document.getElementById('statHoje').textContent = pedidosHoje;
  document.getElementById('statSemana').textContent = pedidosSemana;
  document.getElementById('statMes').textContent = pedidosMes;
  
  // Bateria mais vendida
  const baterias = {};
  pedidos.filter(p => p.tipo === 'bateria').forEach(p => {
    if (p.produto) {
      baterias[p.produto] = (baterias[p.produto] || 0) + 1;
    }
  });
  
  const bateriaMaisVendida = Object.entries(baterias)
    .sort((a, b) => b[1] - a[1])[0];
  
  if (bateriaMaisVendida) {
    document.getElementById('bateriaMaisVendida').innerHTML = `
      <div class="info-box">
        <strong>${bateriaMaisVendida[0]}</strong><br>
        <small>${bateriaMaisVendida[1]} vendas</small>
      </div>`;
  } else {
    document.getElementById('bateriaMaisVendida').innerHTML = '<p style="color: #888;">Nenhuma venda ainda</p>';
  }
  
  // Hor√°rios mais procurados
  const horarios = {};
  pedidos.forEach(p => {
    if (p.horario && p.horario !== 'Imediato') {
      horarios[p.horario] = (horarios[p.horario] || 0) + 1;
    }
  });
  
  const top3Horarios = Object.entries(horarios)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3);
  
  if (top3Horarios.length > 0) {
    let html = '<div class="info-box">';
    top3Horarios.forEach(([horario, qtd], i) => {
      html += `${i+1}¬∫ ${horario} (${qtd} pedidos)<br>`;
    });
    html += '</div>';
    document.getElementById('horariosMaisProcurados').innerHTML = html;
  } else {
    document.getElementById('horariosMaisProcurados').innerHTML = '<p style="color: #888;">Nenhum pedido ainda</p>';
  }
}

// ================== ADMIN - LOGIN ==================

function tentarAbrirAdmin() {
  document.getElementById('modalLogin').classList.add('ativo');
  document.getElementById('senhaAdmin').value = '';
  document.getElementById('erroSenha').classList.add('hidden');
  setTimeout(() => document.getElementById('senhaAdmin').focus(), 100);
}

function verificarSenha() {
  const senha = document.getElementById('senhaAdmin').value;
  
  if (senha === SENHA_ADMIN) {
    fecharLogin();
    abrirAdmin();
  } else {
    document.getElementById('erroSenha').classList.remove('hidden');
    document.getElementById('senhaAdmin').value = '';
    document.getElementById('senhaAdmin').focus();
  }
}

function fecharLogin() {
  document.getElementById('modalLogin').classList.remove('ativo');
}

// ================== ADMIN - PAINEL ==================

function abrirAdmin() {
  const modal = document.getElementById('modalAdmin');
  modal.classList.add('ativo');
  marcarPedidosComoLidos();
  calcularEstatisticas();
  atualizarTabPedidos();
  atualizarTabBloqueados();
  atualizarListaCupons();
}

function fecharAdmin() {
  document.getElementById('modalAdmin').classList.remove('ativo');
  modoAdmin = false;
}

function mudarTab(nome) {
  // Atualizar bot√µes
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('ativo'));
  event.target.classList.add('ativo');
  
  // Atualizar conte√∫do
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('ativo'));
  
  if (nome === 'stats') {
    document.getElementById('tabStats').classList.add('ativo');
    calcularEstatisticas();
  } else if (nome === 'pedidos') {
    document.getElementById('tabPedidos').classList.add('ativo');
    atualizarTabPedidos();
  } else if (nome === 'bloquear') {
    document.getElementById('tabBloquear').classList.add('ativo');
  } else if (nome === 'bloqueados') {
    document.getElementById('tabBloqueados').classList.add('ativo');
    atualizarTabBloqueados();
  } else if (nome === 'config') {
    document.getElementById('tabConfig').classList.add('ativo');
    atualizarListaCupons();
  }
}

function atualizarTabPedidos() {
  const lista = document.getElementById('listaPedidos');
  const pedidos = buscarPedidos();
  
  if (pedidos.length === 0) {
    lista.innerHTML = '<p style="color: #888; text-align: center;">Nenhum pedido ainda.</p>';
    return;
  }
  
  pedidos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  let html = '';
  pedidos.forEach(p => {
    const data = new Date(p.dataAgendamento + 'T12:00:00').toLocaleDateString('pt-BR');
    const dataPedido = new Date(p.timestamp).toLocaleString('pt-BR');
    const novoClass = !p.lido ? 'novo' : '';
    
    html += `
      <div class="pedido-item ${novoClass}">
        <div class="pedido-header">
          <strong>${p.nome}</strong>
          <button class="danger" style="width: auto; padding: 6px 12px; margin: 0; font-size: 12px;" 
                  onclick="if(confirm('Remover este pedido?')) { removerPedido(${p.id}); atualizarTabPedidos(); calcularEstatisticas(); }">
            ‚ùå Remover
          </button>
        </div>
        <small>üìÖ Agendado: ${data} √†s ${p.horario}</small><br>
        <small>üì± ${p.telefone}</small><br>
        <small>üöó ${p.veiculo}</small><br>
        ${p.tipo === 'bateria' ? `<small>üîã ${p.produto}</small><br>` : '<small>üöó Socorro</small><br>'}
        ${p.cupom ? `<small style="color: #28a745;">üéüÔ∏è Cupom: ${p.cupom.codigo} (-${p.cupom.desconto}%)</small><br>` : ''}
        <small>üí∞ R$ ${p.valorComDesconto || p.valorFinal || 50}</small><br>
        <small style="color: #666;">Pedido em: ${dataPedido}</small>
      </div>`;
  });
  
  lista.innerHTML = html;
}

function mostrarHorariosBloqueio() {
  const data = document.getElementById('dataBloqueio').value;
  if (!data) return;
  
  dataAdminSelecionada = data;
  const divHorarios = document.getElementById('horariosBloqueio');
  
  const dataObj = new Date(data + 'T12:00:00');
  const diaSemana = dataObj.getDay();
  
  let horariosDisponiveis = [];
  
  if (diaSemana === 0) {
    for (let h = 9; h <= 22; h++) {
      horariosDisponiveis.push(`${h.toString().padStart(2, '0')}:00`);
    }
  } else if (diaSemana === 6) {
    for (let h = 13; h <= 22; h++) {
      horariosDisponiveis.push(`${h.toString().padStart(2, '0')}:00`);
    }
  } else {
    horariosDisponiveis = ["18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30", "22:00"];
  }
  
  let html = '<div class="horarios">';
  horariosDisponiveis.forEach(h => {
    const ocupado = verificarHorarioOcupado(data, h);
    const classes = ocupado ? 'horario ocupado' : 'horario admin-mode';
    const onclick = `toggleBloqueioHorario('${data}', '${h}')`;
    
    html += `<div class="${classes}" onclick="${onclick}">${h}</div>`;
  });
  html += '</div>';
  
  divHorarios.innerHTML = html;
}

function toggleBloqueioHorario(data, horario) {
  const bloqueados = buscarHorariosBloqueados();
  const existe = bloqueados.find(h => h.data === data && h.horario === horario);
  
  if (existe) {
    desbloquearHorario(existe.id);
  } else {
    bloquearHorario(data, horario);
  }
  
  mostrarHorariosBloqueio();
  atualizarTabBloqueados();
}

function atualizarTabBloqueados() {
  const lista = document.getElementById('listaBloqueados');
  const bloqueados = buscarHorariosBloqueados();
  
  if (bloqueados.length === 0) {
    lista.innerHTML = '<p style="color: #888; text-align: center;">Nenhum hor√°rio bloqueado.</p>';
    return;
  }
  
  bloqueados.sort((a, b) => new Date(a.data + ' ' + a.horario) - new Date(b.data + ' ' + b.horario));
  
  let html = '';
  bloqueados.forEach(h => {
    const data = new Date(h.data + 'T12:00:00').toLocaleDateString('pt-BR');
    
    html += `
      <div class="horario-bloqueado-item">
        <div>
          <strong>üìÖ ${data} √†s ${h.horario}</strong><br>
          <small>${h.motivo}</small>
        </div>
        <button class="danger" onclick="desbloquearHorario(${h.id}); atualizarTabBloqueados(); mostrarHorariosBloqueio();">
          üóëÔ∏è Liberar
        </button>
      </div>`;
  });
  
  lista.innerHTML = html;
}

function alterarCor(cor) {
  // Aqui voc√™ pode adicionar l√≥gica para mudar a cor principal do site
  localStorage.setItem('corPrincipal', cor);
}

// ================== FUN√á√ïES PRINCIPAIS ==================

function limparFluxo() {
  etapas.innerHTML = "";
  bateriasDiv.innerHTML = "";
  dadosDiv.innerHTML = "";
  pagamentoDiv.innerHTML = "";
  agenda.innerHTML = "";
  resumo.innerHTML = "";
}

function selecionarServico(tipo) {
  pedido = { tipo };
  limparFluxo();

  if (tipo === "socorro") {
    mostrarDadosSocorro();
    return;
  }

  etapas.innerHTML = `
    <div class="box">
      <h3>‚ö° Selecione a amperagem</h3>
      <button class="secondary" onclick="mostrarBaterias(45)">45 amperes</button>
      <button class="secondary" onclick="mostrarBaterias(50)">50 amperes (Caixa Alta)</button>
      <button class="secondary" onclick="mostrarBaterias(60)">60 amperes</button>
      <button class="secondary" onclick="mostrarBaterias(70)">70 amperes</button>
    </div>`;
}

function mostrarDadosSocorro() {
  dadosDiv.innerHTML = `
    <div class="box">
      <h3>üöó Socorro / Transfer√™ncia</h3>
      <input type="text" placeholder="Nome completo *" oninput="pedido.nome=this.value">
      <input type="tel" placeholder="Telefone *" oninput="pedido.telefone=this.value">
      <input type="text" placeholder="Modelo do carro *" oninput="pedido.modelo=this.value">
      <input type="text" placeholder="Ano do carro *" oninput="pedido.ano=this.value">
      <textarea placeholder="Endere√ßo detalhado *" oninput="pedido.endereco=this.value" rows="3"></textarea>
      <textarea placeholder="Observa√ß√µes (opcional)" oninput="pedido.observacoes=this.value" rows="2"></textarea>
      <button class="primary" onclick="validarDadosSocorro()">Continuar para agendamento</button>
    </div>`;
}

function validarDadosSocorro() {
  if (!pedido.nome || !pedido.telefone || !pedido.modelo || !pedido.ano || !pedido.endereco) {
    alert("‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios.");
    return;
  }
  pedido.veiculo = `${pedido.modelo} ${pedido.ano}`;
  mostrarAgendamento();
}

function mostrarBaterias(amp) {
  pedido.amperagem = amp;
  pedido.valorCasco = bateriasCarro[amp].casco;
  bateriasDiv.innerHTML = "";

  let html = bateriasCarro[amp].baterias.map((b,i)=>`
    <button class="secondary" onclick="selecionarBateria(${i})">
      <strong>${b.nome}</strong><br>
      üí∞ √Ä vista R$ ${b.vista} | üí≥ At√© 10x R$ ${b.prazo}
    </button>`).join("");

  bateriasDiv.innerHTML = `
    <div class="box">
      <h3>üîã Escolha a bateria (${amp}Ah)</h3>
      <div class="info-box">
        <small>üí° Casco desta amperagem: R$ ${pedido.valorCasco}</small>
      </div>
      ${html}
    </div>`;
}

function selecionarBateria(i) {
  pedido.bateria = bateriasCarro[pedido.amperagem].baterias[i];
  pedido.produto = pedido.bateria.nome;

  dadosDiv.innerHTML = `
    <div class="box">
      <h3>üìã Seus dados</h3>
      <input type="text" placeholder="Nome completo *" oninput="pedido.nome=this.value">
      <input type="tel" placeholder="Telefone *" oninput="pedido.telefone=this.value">
      <input type="text" placeholder="Modelo do carro *" oninput="pedido.modelo=this.value">
      <input type="text" placeholder="Ano do carro *" oninput="pedido.ano=this.value">
      <textarea placeholder="Endere√ßo de entrega *" oninput="pedido.endereco=this.value" rows="3"></textarea>
      <button class="primary" onclick="validarDados()">Continuar</button>
    </div>`;
  
  dadosDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function validarDados() {
  if (!pedido.nome || !pedido.telefone || !pedido.modelo || !pedido.ano || !pedido.endereco) {
    alert("‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios.");
    return;
  }
  pedido.veiculo = `${pedido.modelo} ${pedido.ano}`;
  mostrarTrocaCasco();
}

function mostrarTrocaCasco() {
  pagamentoDiv.innerHTML = `
    <div class="box">
      <h3>üîÑ Base de troca</h3>
      <p>Voc√™ tem bateria usada para troca?</p>
      <div class="info-box">
        <small>üí° Com troca: apenas o valor da bateria<br>
        üí° Sem troca: +R$ ${pedido.valorCasco} (casco)</small>
      </div>
      <div class="grid-2">
        <button class="success small-btn" onclick="definirTroca(true)">‚úÖ Sim, tenho</button>
        <button class="secondary small-btn" onclick="definirTroca(false)">‚ùå N√£o tenho</button>
      </div>
    </div>`;
  
  pagamentoDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function definirTroca(temTroca) {
  pedido.base = temTroca;
  mostrarPagamento();
}

function mostrarPagamento() {
  let total = pedido.bateria.vista;
  let cascoTexto = "";
  
  if (!pedido.base) {
    total += pedido.valorCasco;
    cascoTexto = `<p style="color: #ff9800;">‚ö†Ô∏è Sem troca: +R$ ${pedido.valorCasco} (casco)</p>`;
  }

  pagamentoDiv.innerHTML = `
    <div class="box">
      <h3>üí≥ Forma de Pagamento</h3>
      <div class="info-box">
        <p><strong>${pedido.bateria.nome}</strong></p>
        <p>üí∞ √Ä vista: R$ ${pedido.bateria.vista}</p>
        ${cascoTexto}
        <p style="font-size: 16px; color: #28a745;"><strong>Total √† vista: R$ ${total}</strong></p>
      </div>
      
      <select id="selectPagamento" onchange="selecionarFormaPagamento(this.value)">
        <option value="">Selecione forma de pagamento</option>
        <option value="pix">üí∞ PIX</option>
        <option value="dinheiro">üíµ Dinheiro</option>
        <option value="debito">üí≥ Cart√£o D√©bito</option>
        <option value="credito_vista">üí≥ Cart√£o Cr√©dito √† Vista</option>
        <option value="credito_parcelado">üí≥ Cart√£o Cr√©dito Parcelado (2x-10x)</option>
      </select>
      
      <div id="dinheiroDiv"></div>
      <div id="parcelasDiv"></div>
      <div id="cupomDiv"></div>
      <div id="btnContinuar"></div>
    </div>`;
  
  pagamentoDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function selecionarFormaPagamento(forma) {
  pedido.formaPagamento = forma;
  const dinheiroDiv = document.getElementById("dinheiroDiv");
  const parcelasDiv = document.getElementById("parcelasDiv");
  const cupomDiv = document.getElementById("cupomDiv");
  const btnContinuar = document.getElementById("btnContinuar");
  
  dinheiroDiv.innerHTML = "";
  parcelasDiv.innerHTML = "";
  cupomDiv.innerHTML = "";
  btnContinuar.innerHTML = "";
  
  if (forma === "dinheiro") {
    dinheiroDiv.innerHTML = `
      <div style="margin-top: 15px;">
        <p>üíµ Precisa de troco?</p>
        <div class="grid-2">
          <button class="secondary small-btn" onclick="definirTroco(true)">Sim</button>
          <button class="secondary small-btn" onclick="definirTroco(false)">N√£o</button>
        </div>
        <div id="valorTrocoDiv"></div>
      </div>`;
  } else if (forma === "credito_parcelado") {
    mostrarParcelas();
  } else if (forma) {
    pedido.parcelas = 1;
    pedido.valorFinal = pedido.base ? pedido.bateria.vista : (pedido.bateria.vista + pedido.valorCasco);
    mostrarCampoCupom();
  }
}

function mostrarCampoCupom() {
  const cupomDiv = document.getElementById("cupomDiv");
  const btnContinuar = document.getElementById("btnContinuar");
  
  cupomDiv.innerHTML = `
    <div class="cupom-box">
      <label>üéüÔ∏è Tem um cupom de desconto?</label>
      <input type="text" id="inputCupom" placeholder="Digite o c√≥digo" style="margin-top: 8px;">
      <button class="secondary" onclick="validarCupom()" style="margin-top: 8px;">Aplicar Cupom</button>
      <div id="cupomResultado"></div>
    </div>`;
  
  btnContinuar.innerHTML = `<button class="primary" onclick="mostrarAgendamento()" style="margin-top: 15px;">Continuar para agendamento</button>`;
}

function validarCupom() {
  const codigo = document.getElementById('inputCupom').value;
  const resultado = document.getElementById('cupomResultado');
  
  if (aplicarCupom(codigo)) {
    resultado.innerHTML = `
      <div class="cupom-aplicado">
        ‚úÖ Cupom aplicado! ${pedido.cupom.desconto}% de desconto<br>
        <small>De R$ ${pedido.valorFinal.toFixed(2)} por R$ ${pedido.valorComDesconto.toFixed(2)}</small>
      </div>`;
  } else {
    resultado.innerHTML = '<p class="error">‚ùå Cupom inv√°lido</p>';
    setTimeout(() => resultado.innerHTML = '', 3000);
  }
}

function definirTroco(precisaTroco) {
  pedido.precisaTroco = precisaTroco;
  const valorTrocoDiv = document.getElementById("valorTrocoDiv");
  const btnContinuar = document.getElementById("btnContinuar");
  
  if (precisaTroco) {
    valorTrocoDiv.innerHTML = `
      <input type="number" id="valorTroco" placeholder="Para quanto? (ex: 100)" 
             oninput="pedido.valorTroco=this.value" 
             style="margin-top: 10px;">`;
  } else {
    valorTrocoDiv.innerHTML = "";
  }
  
  pedido.parcelas = 1;
  pedido.valorFinal = pedido.base ? pedido.bateria.vista : (pedido.bateria.vista + pedido.valorCasco);
  mostrarCampoCupom();
}

function validarTroco() {
  if (pedido.precisaTroco && !pedido.valorTroco) {
    alert("‚ö†Ô∏è Por favor, informe para quanto precisa de troco.");
    return;
  }
  mostrarAgendamento();
}

function mostrarParcelas() {
  const parcelasDiv = document.getElementById("parcelasDiv");
  let total = pedido.base ? pedido.bateria.prazo : (pedido.bateria.prazo + pedido.valorCasco);
  
  let parcelasHtml = "<h4 style='margin-top: 15px;'>üí≥ Escolha as parcelas</h4><div class='parcelas-grid'>";
  for (let i = 2; i <= 10; i++) {
    let valorParcela = (total / i).toFixed(2);
    parcelasHtml += `<button class="secondary" onclick="selecionarParcelas(${i}, ${valorParcela})">${i}x R$ ${valorParcela}</button>`;
  }
  parcelasHtml += "</div>";
  
  parcelasDiv.innerHTML = parcelasHtml;
}

function selecionarParcelas(qtd, valor) {
  pedido.parcelas = qtd;
  pedido.valorParcela = valor;
  pedido.valorFinal = pedido.base ? pedido.bateria.prazo : (pedido.bateria.prazo + pedido.valorCasco);
  
  const parcelasDiv = document.getElementById("parcelasDiv");
  const btnContinuar = document.getElementById("btnContinuar");
  
  parcelasDiv.innerHTML = `
    <div class="info-box" style="margin-top: 15px;">
      <p style="color: #28a745;">‚úÖ Selecionado: ${qtd}x de R$ ${valor}</p>
      <p><strong>Total: R$ ${pedido.valorFinal}</strong></p>
    </div>`;
  
  mostrarCampoCupom();
}

// ================== AGENDAMENTO COM CALEND√ÅRIO ==================

function mostrarAgendamento() {
  const hoje = new Date();
  mesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  
  agenda.innerHTML = `
    <div class="box">
      <h3>üìÖ Agendamento</h3>
      ${pedido.tipo === "socorro" ? 
        '<div class="info-box"><small>üö® Socorro - R$ 50,00<br>üì¶ Pode agendar a qualquer momento para os hor√°rios:<br>Seg-Sex 18:30-22h | S√°b 13-22h | Dom 9-22h<br>üî• "Imediato" dispon√≠vel apenas durante hor√°rio de atendimento</small></div>' :
        '<div class="info-box"><small>üì¶ Seg-Sex: pe√ßa at√© 18h | S√°b: at√© 12h<br>üöö Entregas: Seg-Sex 18:30-22h | S√°b 13-22h | Dom 9-22h</small></div>'
      }
      
      <div class="calendario-wrapper">
        <div class="mes-header">
          <button class="secondary" onclick="mudarMes(-1)">‚óÄ</button>
          <span class="mes-nome" id="mesNome"></span>
          <button class="secondary" onclick="mudarMes(1)">‚ñ∂</button>
        </div>
        <div id="calendario" class="calendario"></div>
      </div>
      
      <div id="horarios-section" class="horarios-section hidden">
        <h4>‚è∞ Hor√°rios dispon√≠veis</h4>
        <div id="horarios" class="horarios"></div>
      </div>
      
      <button id="confirmarBtn" class="success hidden" onclick="finalizarPedido()">‚úÖ Confirmar pedido</button>
    </div>`;
  
  agenda.scrollIntoView({ behavior: 'smooth', block: 'start' });
  gerarCalendario();
}

function mudarMes(direcao) {
  mesAtual.setMonth(mesAtual.getMonth() + direcao);
  gerarCalendario();
}

function gerarCalendario() {
  const calendario = document.getElementById("calendario");
  const mesNome = document.getElementById("mesNome");
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  
  const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  
  mesNome.textContent = `${meses[mesAtual.getMonth()]} ${mesAtual.getFullYear()}`;
  
  const diasSemana = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
  let html = diasSemana.map(d => `<div class="dia-semana">${d}</div>`).join('');
  
  const primeiroDia = new Date(mesAtual.getFullYear(), mesAtual.getMonth(), 1);
  const ultimoDia = new Date(mesAtual.getFullYear(), mesAtual.getMonth() + 1, 0);
  
  // Dias vazios antes do primeiro dia
  for (let i = 0; i < primeiroDia.getDay(); i++) {
    html += '<div class="dia vazio"></div>';
  }
  
  // Verificar regras de agendamento
  const agora = new Date();
  const horaAtual = agora.getHours();
  const diaAtual = agora.getDay();
  
  let podeAgendarHoje = false;
  if (pedido.tipo === "socorro") {
    podeAgendarHoje = true;
  } else {
    if (diaAtual >= 1 && diaAtual <= 5 && horaAtual < 18) podeAgendarHoje = true;
    if (diaAtual === 6 && horaAtual < 12) podeAgendarHoje = true;
  }
  
  // Gerar dias do m√™s
  for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
    const data = new Date(mesAtual.getFullYear(), mesAtual.getMonth(), dia);
    data.setHours(0, 0, 0, 0);
    const dataStr = data.toISOString().split('T')[0];
    const diaSemana = data.getDay();
    const isDomingo = diaSemana === 0;
    const ehHoje = data.getTime() === hoje.getTime();
    const ehPassado = data < hoje;
    
    let classes = ['dia'];
    let disponivel = true;
    
    if (ehPassado) {
      disponivel = false;
    } else if (ehHoje && !podeAgendarHoje) {
      disponivel = false;
    } else if (isDomingo && pedido.tipo !== "socorro") {
      disponivel = false;
    }
    
    if (!disponivel) classes.push('indisponivel');
    if (ehHoje) classes.push('hoje');
    
    html += `<div class="${classes.join(' ')}" 
             ${disponivel ? `onclick="selecionarDia('${dataStr}')" data-date="${dataStr}"` : ''}>
             ${dia}</div>`;
  }
  
  calendario.innerHTML = html;
}

function selecionarDia(dataStr) {
  pedido.dataAgendamento = dataStr;
  const data = new Date(dataStr + 'T12:00:00');
  
  document.querySelectorAll('.dia').forEach(d => d.classList.remove('selecionado'));
  
  const diaElement = document.querySelector(`[data-date="${dataStr}"]`);
  if (diaElement) {
    diaElement.classList.add('selecionado');
  }
  
  gerarHorarios(data);
}

function gerarHorarios(data) {
  const horariosSection = document.getElementById("horarios-section");
  const horarios = document.getElementById("horarios");
  const diaSemana = data.getDay();
  const dataStr = data.toISOString().split('T')[0];
  const hoje = new Date();
  const agora = hoje.getHours();
  const ehHoje = data.toDateString() === hoje.toDateString();
  
  let horariosDisponiveis = [];
  
  // Hor√°rios de entrega (mesmos para socorro e bateria)
  if (diaSemana === 0) {
    for (let h = 9; h <= 22; h++) {
      horariosDisponiveis.push(`${h.toString().padStart(2, '0')}:00`);
    }
  } else if (diaSemana === 6) {
    for (let h = 13; h <= 22; h++) {
      horariosDisponiveis.push(`${h.toString().padStart(2, '0')}:00`);
    }
  } else {
    horariosDisponiveis = ["18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30", "22:00"];
  }
  
  let htmlHorarios = horariosDisponiveis.map(h => {
    const ocupado = verificarHorarioOcupado(dataStr, h);
    const classes = ocupado ? 'horario ocupado' : 'horario';
    const onclick = ocupado ? '' : `onclick="selecionarHorario('${h}')"`;
    return `<div class="${classes}" ${onclick}>${h}</div>`;
  }).join("");
  
  // Adicionar bot√£o "Imediato" para socorro SE for hoje E estiver no hor√°rio de atendimento
  if (pedido.tipo === "socorro" && ehHoje) {
    let dentroHorario = false;
    
    if (diaSemana === 0 && agora >= 9 && agora < 22) {
      dentroHorario = true;
    } else if (diaSemana === 6 && agora >= 13 && agora < 22) {
      dentroHorario = true;
    } else if (diaSemana >= 1 && diaSemana <= 5 && agora >= 18 && agora < 22) {
      dentroHorario = true;
    }
    
    if (dentroHorario) {
      htmlHorarios = `<div class="horario" onclick="selecionarHorario('Imediato')" style="background: #ff6b6b; grid-column: span 3;">üö® Socorro Imediato</div>` + htmlHorarios;
    }
  }
  
  horarios.innerHTML = htmlHorarios;
  horariosSection.classList.remove('hidden');
  
  setTimeout(() => {
    horariosSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);
}

function selecionarHorario(horario) {
  pedido.horario = horario;
  
  document.querySelectorAll('.horario').forEach(h => h.classList.remove('selecionado'));
  event.target.classList.add('selecionado');
  
  document.getElementById("confirmarBtn").classList.remove('hidden');
}

function finalizarPedido() {
  if (!pedido.nome || !pedido.telefone || !pedido.endereco) {
    alert("‚ö†Ô∏è Dados incompletos!");
    return;
  }
  
  if (!pedido.dataAgendamento || !pedido.horario) {
    alert("‚ö†Ô∏è Selecione data e hor√°rio!");
    return;
  }
  
  // Adicionar valor para socorro
  if (pedido.tipo === "socorro") {
    pedido.valorFinal = 50;
    pedido.produto = "Socorro / Transfer√™ncia";
  }
  
  // Salvar pedido
  salvarPedido(pedido);
  
  mostrarResumoFinal();
}

function mostrarResumoFinal() {
  const data = new Date(pedido.dataAgendamento + 'T12:00:00');
  const dataFormatada = data.toLocaleDateString('pt-BR');
  
  let resumoHtml = `
    <div class="box">
      <h3>‚úÖ Pedido Confirmado!</h3>
      <div class="info-box">`;
  
  if (pedido.tipo === "bateria") {
    let valorExibir = pedido.valorComDesconto || pedido.valorFinal || pedido.bateria.vista;
    let formaPagTexto = pedido.formaPagamento.replace('_', ' ').toUpperCase();
    let parcelasTexto = "";
    
    if (pedido.parcelas > 1) {
      parcelasTexto = `${pedido.parcelas}x de R$ ${pedido.valorParcela}`;
    } else {
      parcelasTexto = `√Ä vista - R$ ${valorExibir.toFixed(2)}`;
    }
    
    resumoHtml += `
      <p><strong>üîã ${pedido.bateria.nome}</strong></p>
      <p>‚ö° ${pedido.amperagem}Ah</p>
      <p>üí≥ ${formaPagTexto}: ${parcelasTexto}</p>
      <p>üîÑ Troca: ${pedido.base ? 'Sim' : 'N√£o (+ casco R$ ' + pedido.valorCasco + ')'}</p>`;
    
    if (pedido.cupom) {
      resumoHtml += `<p style="color: #28a745;">üéüÔ∏è Cupom ${pedido.cupom.codigo}: -${pedido.cupom.desconto}%</p>`;
      resumoHtml += `<p><strong>üí∞ Total com desconto: R$ ${valorExibir.toFixed(2)}</strong></p>`;
    }
    
    if (pedido.formaPagamento === "dinheiro" && pedido.precisaTroco) {
      resumoHtml += `<p>üíµ Troco para: R$ ${pedido.valorTroco}</p>`;
    }
  } else {
    resumoHtml += `
      <p><strong>üöó Socorro / Transfer√™ncia</strong></p>
      <p>üí∞ Valor: R$ 50,00</p>`;
  }
  
  resumoHtml += `
        <hr style="border-color: #2c3a5f; margin: 10px 0;">
        <p>üë§ <strong>${pedido.nome}</strong></p>
        <p>üì± ${pedido.telefone}</p>
        <p>üöó ${pedido.veiculo}</p>
        <p>üìç ${pedido.endereco}</p>
        <p>üìÖ ${dataFormatada} √†s ${pedido.horario}</p>
        ${pedido.observacoes ? `<p>üìù ${pedido.observacoes}</p>` : ''}
      </div>
      <button class="success" onclick="enviarWhatsApp()">üì± Enviar para WhatsApp</button>
      <button class="secondary" onclick="location.reload()" style="margin-top: 10px;">üîÑ Fazer novo pedido</button>
    </div>`;
    
  resumo.innerHTML = resumoHtml;
  resumo.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function enviarWhatsApp() {
  const data = new Date(pedido.dataAgendamento + 'T12:00:00').toLocaleDateString('pt-BR');
  
  // EMOJIS COMPAT√çVEIS COM WHATSAPP
  let mensagem = `*NOVO PEDIDO*\n\n`;
  
  if (pedido.tipo === "bateria") {
    mensagem += `*PRODUTO*\n`;
    mensagem += `Bateria: ${pedido.bateria.nome}\n`;
    mensagem += `Amperagem: ${pedido.amperagem}Ah\n\n`;
    
    mensagem += `*PAGAMENTO*\n`;
    let formaPag = pedido.formaPagamento.replace('_', ' ').toUpperCase();
    mensagem += `Forma: ${formaPag}`;
    
    if (pedido.parcelas > 1) {
      mensagem += ` - ${pedido.parcelas}x R$ ${pedido.valorParcela}\n`;
      mensagem += `Total: R$ ${pedido.valorFinal}\n`;
    } else {
      let valorFinal = pedido.valorComDesconto || pedido.valorFinal;
      mensagem += `\nTotal: R$ ${valorFinal.toFixed(2)}\n`;
    }
    
    mensagem += `Base de troca: ${pedido.base ? 'SIM' : 'NAO (+ casco R$ ' + pedido.valorCasco + ')'}\n`;
    
    if (pedido.cupom) {
      mensagem += `Cupom: ${pedido.cupom.codigo} (-${pedido.cupom.desconto}%)\n`;
    }
    
    if (pedido.formaPagamento === "dinheiro") {
      mensagem += `Troco: ${pedido.precisaTroco ? 'SIM - Para R$ ' + pedido.valorTroco : 'NAO'}\n`;
    }
    
    mensagem += `\n`;
  } else {
    mensagem += `*SERVICO*\nSocorro / Transferencia de Carga\n`;
    mensagem += `Valor: R$ 50,00\n\n`;
  }
  
  mensagem += `*CLIENTE*\n`;
  mensagem += `Nome: ${pedido.nome}\n`;
  mensagem += `Telefone: ${pedido.telefone}\n`;
  mensagem += `Veiculo: ${pedido.veiculo}\n`;
  
  // Adicionar link do Google Maps
  const enderecoEncoded = encodeURIComponent(pedido.endereco);
  mensagem += `Endereco: ${pedido.endereco}\n`;
  mensagem += `Maps: https://www.google.com/maps/search/?api=1&query=${enderecoEncoded}\n\n`;
  
  mensagem += `*AGENDAMENTO*\n`;
  mensagem += `Data: ${data}\n`;
  mensagem += `Horario: ${pedido.horario}\n`;
  
  if (pedido.observacoes) {
    mensagem += `\n*OBSERVACOES*\n${pedido.observacoes}\n`;
  }
  
  const url = `https://wa.me/554391261624?text=${encodeURIComponent(mensagem)}`;
  window.open(url, '_blank');
}

// Prevenir reload ao apertar Enter
document.addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
    e.preventDefault();
  }
});

// Atualizar badge ao carregar p√°gina
atualizarBadgeAdmin();
</script>

</body>
</html>